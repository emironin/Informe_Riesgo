<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe de Riesgo</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest and Theme -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1d4ed8">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Hide file input default UI */
        input[type="file"] {
            display: none;
        }
        /* Custom styles for the report area to ensure clean PDF export */
        #report-content {
            box-shadow: none;
        }
        /* Styling for the risk level display */
        #risk-display {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto max-w-2xl p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Informe de Riesgo</h1>
            <p class="text-sm text-gray-500">Creada por JAE SISTEMAS</p>
        </header>

        <!-- Main Report Area -->
        <main id="report-content" class="bg-white p-6 rounded-lg shadow-lg">
            
            <!-- Company Info Section -->
            <div class="grid grid-cols-3 gap-4 mb-6 items-center">
                <div class="col-span-1">
                    <label for="logo-upload" class="cursor-pointer">
                        <img id="logo-preview" src="https://placehold.co/150x150/e2e8f0/cbd5e0?text=Logo" alt="Logo de la empresa" class="w-full h-auto object-cover rounded-md bg-gray-200">
                    </label>
                    <input id="logo-upload" type="file" accept="image/*">
                </div>
                <div class="col-span-2 space-y-3">
                    <input id="company-name" type="text" placeholder="Nombre de la Empresa" class="w-full p-2 border rounded-md">
                    <input id="cuit" type="text" placeholder="CUIT" class="w-full p-2 border rounded-md">
                    <input id="phone" type="tel" placeholder="Teléfono" class="w-full p-2 border rounded-md">
                    <input id="email" type="email" placeholder="E-mail" class="w-full p-2 border rounded-md">
                </div>
            </div>

            <!-- Date and Time -->
            <div class="mb-6">
                <p class="text-sm text-gray-600"><strong>Fecha y Hora:</strong> <span id="datetime"></span></p>
            </div>
            <hr class="mb-6">

            <!-- Photo and Risk Assessment Section -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Photo Upload -->
                <div>
                    <h2 class="font-bold text-lg mb-2">Fotografía de Evidencia</h2>
                    <label for="photo-upload" class="cursor-pointer block w-full h-auto aspect-square bg-gray-200 rounded-lg flex items-center justify-center text-gray-500 hover:bg-gray-300 transition-colors">
                        <img id="photo-preview" src="https://placehold.co/600x600/e2e8f0/cbd5e0?text=Cargar+Foto+(600x600)" alt="Vista previa de la foto" class="w-full h-full object-cover rounded-lg">
                    </label>
                    <input id="photo-upload" type="file" accept="image/*" capture="environment">
                    <canvas id="photo-canvas" width="600" height="600" class="hidden"></canvas>
                </div>

                <!-- Risk Checklist -->
                <div>
                    <h2 class="font-bold text-lg mb-2">Nivel de Riesgo</h2>
                    <div class="space-y-3">
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border has-[:checked]:bg-green-100 has-[:checked]:border-green-400">
                            <input type="radio" name="risk" value="SIN RIESGO" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                            <span class="ml-3 text-gray-700">Sin Riesgo</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border has-[:checked]:bg-yellow-100 has-[:checked]:border-yellow-400">
                            <input type="radio" name="risk" value="BAJO RIESGO" class="h-4 w-4 text-yellow-600 border-gray-300 focus:ring-yellow-500">
                            <span class="ml-3 text-gray-700">Bajo Riesgo</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border has-[:checked]:bg-orange-100 has-[:checked]:border-orange-400">
                            <input type="radio" name="risk" value="RIESGO MEDIO" class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500">
                            <span class="ml-3 text-gray-700">Riesgo Medio</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border has-[:checked]:bg-red-100 has-[:checked]:border-red-400">
                            <input type="radio" name="risk" value="ALTO RIESGO" class="h-4 w-4 text-red-600 border-gray-300 focus:ring-red-500">
                            <span class="ml-3 text-gray-700">Alto Riesgo</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Risk Level Display -->
            <div id="risk-display-container" class="mt-4 text-center h-10 flex items-center justify-center">
                 <p id="risk-display" class="font-bold uppercase px-4 py-2 rounded-md" style="opacity: 0;"></p>
            </div>

            <!-- Observations Section -->
            <div class="mt-6">
                <h2 class="font-bold text-lg mb-2">Observaciones</h2>
                <textarea id="observations" rows="5" class="w-full p-2 border rounded-md" placeholder="Escriba aquí sus observaciones..."></textarea>
            </div>
        </main>
        
        <!-- Action Button -->
        <footer class="mt-6 text-center">
            <button id="export-pdf" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all shadow-md w-full sm:w-auto">
                Generar y Exportar PDF
            </button>
        </footer>
    </div>

    <!-- Modal for Email Prompt -->
    <div id="email-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <h3 class="text-lg font-medium text-gray-900 mb-2">PDF Generado</h3>
            <p class="text-sm text-gray-600 mb-4">El informe se ha descargado. ¿Deseas enviarlo por correo electrónico?</p>
            <div class="flex justify-center gap-4">
                <button id="email-no" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">No</button>
                <button id="email-yes" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Sí, Enviar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Loading State -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 text-center">
            <p class="text-lg font-medium text-gray-900">Generando PDF...</p>
        </div>
    </div>


    <script>
            document.addEventListener('DOMContentLoaded', function () {
            // --- ELEMENTS ---
            const logoUpload = document.getElementById('logo-upload');
            const logoPreview = document.getElementById('logo-preview');
            const photoUpload = document.getElementById('photo-upload');
            const photoPreview = document.getElementById('photo-preview');
            const photoCanvas = document.getElementById('photo-canvas');
            const riskRadios = document.querySelectorAll('input[name="risk"]');
            const riskDisplay = document.getElementById('risk-display');
            const exportPdfBtn = document.getElementById('export-pdf');
            const emailModal = document.getElementById('email-modal');
            const loadingModal = document.getElementById('loading-modal');
            const emailYesBtn = document.getElementById('email-yes');
            const emailNoBtn = document.getElementById('email-no');
            const observationsTextarea = document.getElementById('observations');
            const reportContent = document.getElementById('report-content'); // Mover esto fuera para que sea accesible
        
            // --- INITIALIZATION ---
            // Set current date and time
            const now = new Date();
            document.getElementById('datetime').textContent = now.toLocaleString('es-AR');
        
            // --- EVENT LISTENERS ---
        
            // Handle Logo Upload
            logoUpload.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        logoPreview.src = e.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });
        
            // Handle Photo Upload and Processing
            photoUpload.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            const ctx = photoCanvas.getContext('2d');
                            ctx.fillStyle = 'white';
                            ctx.fillRect(0, 0, 600, 600);
                            const scale = Math.min(600 / img.width, 600 / img.height);
                            const x = (600 / 2) - (img.width / 2) * scale;
                            const y = (600 / 2) - (img.height / 2) * scale;
                            ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                            photoPreview.src = photoCanvas.toDataURL('image/jpeg', 0.9);
                        }
                        img.src = e.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });
        
            // Handle Risk Level Change
            riskRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const value = this.value;
                    riskDisplay.textContent = value;
                    riskDisplay.style.opacity = '1';
                    riskDisplay.classList.remove('bg-green-200', 'text-green-800', 'bg-yellow-200', 'text-yellow-800', 'bg-orange-200', 'text-orange-800', 'bg-red-200', 'text-red-800');
                    switch (value) {
                        case 'SIN RIESGO':
                            riskDisplay.classList.add('bg-green-200', 'text-green-800');
                            break;
                        case 'BAJO RIESGO':
                            riskDisplay.classList.add('bg-yellow-200', 'text-yellow-800');
                            break;
                        case 'RIESGO MEDIO':
                            riskDisplay.classList.add('bg-orange-200', 'text-orange-800');
                            break;
                        case 'ALTO RIESGO':
                            riskDisplay.classList.add('bg-red-200', 'text-red-800');
                            break;
                    }
                });
            });
        
            // Handle PDF Export
            exportPdfBtn.addEventListener('click', function() {
                loadingModal.classList.remove('hidden');
        
                // Clonar el contenido para manipularlo sin afectar la vista del usuario
                // y asegurar que se renderice como queremos para el PDF
                html2canvas(reportContent, {
                    scale: 3, // Aumentar la escala para mayor resolución del PDF (2 es un buen mínimo, 3 o 4 mejor para texto legible)
                    useCORS: true,
                    logging: false,
                    // scrollY: -window.scrollY, // Esto ayuda a capturar la parte superior si la página está desplazada
                    windowWidth: reportContent.scrollWidth, // Asegura que la captura tenga el ancho completo del contenido
                    windowHeight: reportContent.scrollHeight, // Asegura que la captura tenga la altura completa del contenido
                    onclone: (clonedDoc) => {
                        // Seleccionar el contenedor principal que tiene el 'max-w-2xl'
                        const mainContainer = clonedDoc.querySelector('.container.mx-auto.max-w-2xl');
                        
                        // Si existe el contenedor, forzamos su ancho para la captura
                        // El ancho de A4 es 210mm. 1 mm = 3.779528 px (a 96 DPI).
                        // 210mm * 3.779528 px/mm = 793.69 px. Redondeamos a 794px.
                        // Ajustamos este ancho para que la captura se haga con una proporción de A4.
                        // Es crucial para que html2canvas genere una imagen con proporciones de A4.
                        if (mainContainer) {
                            mainContainer.style.width = '794px'; 
                            // Quitar los paddings que Tailwind aplica, para que no resten del 794px si queremos que el contenido ocupe todo el ancho del PDF
                            mainContainer.style.paddingLeft = '0px'; 
                            mainContainer.style.paddingRight = '0px';
                        }
        
                        // Asegurar que el valor del textarea se refleje en el clon
                        const clonedObservations = clonedDoc.getElementById('observations');
                        clonedObservations.textContent = observationsTextarea.value; // Usar textContent para textarea
                        // Es importante que el textarea no tenga scroll interno y su contenido sea visible
                        clonedObservations.style.overflow = 'visible';
                        clonedObservations.style.height = 'auto'; // Ajustar altura automáticamente
                        clonedObservations.style.minHeight = observationsTextarea.scrollHeight + 'px'; // Asegurar que tenga al menos la altura actual
                        
                        // Asegurar que el display del riesgo sea visible en el clon
                        const clonedRiskDisplay = clonedDoc.getElementById('risk-display');
                        if (clonedRiskDisplay.textContent) {
                            clonedRiskDisplay.style.opacity = '1';
                        }
        
                        // Opcional: Remover cualquier sombra o borde que no quieras en el PDF
                        const clonedReportContent = clonedDoc.getElementById('report-content');
                        clonedReportContent.style.boxShadow = 'none';
                        clonedReportContent.style.border = 'none';
                    }
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png', 1.0); // Calidad 1.0 para PNG
        
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
        
                    const pdfWidth = pdf.internal.pageSize.getWidth(); // Ancho del PDF en mm (210)
                    const pdfHeight = pdf.internal.pageSize.getHeight(); // Alto del PDF en mm (297)
        
                    // Calcula el ancho y alto de la imagen en mm para que se ajuste al ancho del PDF
                    // sin distorsión, manteniendo la relación de aspecto original de la captura del canvas.
                    const imgWidth = pdfWidth; 
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
                    let heightLeft = imgHeight;
                    let position = 0; // Posición vertical inicial para la imagen en la página del PDF
        
                    // Agregar la primera página
                    // pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight); // Sin márgenes iniciales, luego se aplican
                    
                    // Un pequeño margen para el contenido del PDF si lo deseas
                    const margin = 10; // mm
                    const contentWidth = pdfWidth - (margin * 2);
        
                    pdf.addImage(imgData, 'PNG', margin, margin, contentWidth, imgHeight);
                    heightLeft -= (pdfHeight - margin * 2); // Restamos el alto de la página útil
        
                    // Si el contenido es más largo que una página, añadir páginas adicionales
                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight; // Calcula cuánto de la imagen original ya se ha mostrado
                        pdf.addPage();
                        // La imagen se "recorta" para mostrar solo la parte que no ha sido vista aún
                        pdf.addImage(imgData, 'PNG', margin, position + margin, contentWidth, imgHeight);
                        heightLeft -= (pdfHeight - margin * 2);
                    }
        
        
                    const companyName = document.getElementById('company-name').value || 'SinNombre';
                    const date = new Date().toISOString().slice(0, 10);
                    pdf.save(`InformeDeRiesgo_${companyName}_${date}.pdf`);
        
                    loadingModal.classList.add('hidden');
                    emailModal.classList.remove('hidden');
                }).catch(error => {
                    console.error("Error al generar el PDF:", error);
                    loadingModal.classList.add('hidden');
                    // Aquí puedes mostrar un mensaje de error al usuario
                    alert('Hubo un error al generar el PDF. Por favor, inténtelo de nuevo.');
                });
            });
        
            // Handle Modal Buttons
            emailNoBtn.addEventListener('click', () => {
                emailModal.classList.add('hidden');
            });
        
            emailYesBtn.addEventListener('click', () => {
                const email = document.getElementById('email').value || '';
                const company = document.getElementById('company-name').value || 'Reporte';
                const subject = `Informe de Riesgo - ${company}`;
                const body = `Hola,\n\nAdjunto el informe de riesgo generado para ${company}.\n\nSaludos.`;
                
                // Cierra el modal antes de abrir mailto, para una mejor UX
                emailModal.classList.add('hidden');
                
                // Pequeño retardo para asegurar que el modal se oculte bien antes de la redirección
                setTimeout(() => {
                    window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                }, 100); 
            });
        });
        
        // Register the Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.log('Error al registrar el Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
